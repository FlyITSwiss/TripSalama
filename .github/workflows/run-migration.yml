name: Run Database Migration

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to run (e.g., 006_identity_verification.sql)'
        required: true
        default: '006_identity_verification.sql'

env:
  VPS_HOST: '83.228.205.222'
  VPS_USER: 'debian'
  REMOTE_PATH: '/var/www/tripsalama'

jobs:
  run-migration:
    runs-on: ubuntu-latest
    name: "Run Migration on VPS"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Upload migration file
        run: |
          scp database/migrations/${{ github.event.inputs.migration_file }} \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/

      - name: Run migration via sudo MySQL
        run: |
          echo "=== Running migration on VPS ==="

          # Essayer avec sudo mysql (debian auth socket)
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            echo 'Attempting migration with sudo mysql...'

            # Methode 1: sudo mysql (auth socket)
            if sudo mysql tripsalama < /tmp/${{ github.event.inputs.migration_file }} 2>/dev/null; then
              echo 'Migration completed successfully via sudo!'

              echo 'Verifying new columns:'
              sudo mysql tripsalama -e 'DESCRIBE users;' | grep identity || echo 'No identity columns'

              echo 'Verifying new table:'
              sudo mysql tripsalama -e \"SHOW TABLES LIKE 'identity%';\"
            else
              echo 'sudo mysql failed, trying with debian-sys-maint...'

              # Methode 2: debian-sys-maint user
              if [ -f /etc/mysql/debian.cnf ]; then
                if sudo mysql --defaults-file=/etc/mysql/debian.cnf tripsalama < /tmp/${{ github.event.inputs.migration_file }}; then
                  echo 'Migration completed via debian-sys-maint!'

                  echo 'Verifying:'
                  sudo mysql --defaults-file=/etc/mysql/debian.cnf tripsalama -e 'DESCRIBE users;' | grep identity
                  sudo mysql --defaults-file=/etc/mysql/debian.cnf tripsalama -e \"SHOW TABLES LIKE 'identity%';\"
                else
                  echo 'debian-sys-maint failed too!'

                  # Methode 3: root sans mot de passe
                  echo 'Trying root without password...'
                  if sudo mysql -u root tripsalama < /tmp/${{ github.event.inputs.migration_file }}; then
                    echo 'Migration completed via root!'
                    sudo mysql -u root tripsalama -e 'DESCRIBE users;' | grep identity
                  else
                    echo 'All methods failed!'
                    echo 'Please run manually: sudo mysql tripsalama < /var/www/tripsalama/database/migrations/${{ github.event.inputs.migration_file }}'
                    exit 1
                  fi
                fi
              else
                echo 'No debian.cnf found, trying root...'
                if sudo mysql -u root tripsalama < /tmp/${{ github.event.inputs.migration_file }}; then
                  echo 'Migration completed via root!'
                else
                  echo 'Migration failed! Run manually on VPS.'
                  exit 1
                fi
              fi
            fi

            # Nettoyer
            rm -f /tmp/${{ github.event.inputs.migration_file }}
          "

      - name: Create uploads directory
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            mkdir -p ${{ env.REMOTE_PATH }}/public/uploads/verifications
            chmod 755 ${{ env.REMOTE_PATH }}/public/uploads/verifications
            echo 'Uploads directory created'
          "

      - name: Summary
        run: |
          echo "## Migration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Migration File | ${{ github.event.inputs.migration_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Completed |" >> $GITHUB_STEP_SUMMARY
