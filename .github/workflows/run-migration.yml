name: Run Database Migration

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to run (e.g., 006_identity_verification.sql)'
        required: true
        default: '006_identity_verification.sql'

env:
  VPS_HOST: '83.228.205.222'
  VPS_USER: 'debian'
  REMOTE_PATH: '/var/www/tripsalama'

jobs:
  run-migration:
    runs-on: ubuntu-latest
    name: "Run Migration on VPS"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Upload migration file
        run: |
          scp database/migrations/${{ github.event.inputs.migration_file }} \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/

      - name: Run migration via Docker or native MySQL
        run: |
          # Copier le fichier migration sur le VPS
          echo "=== Running migration on VPS ==="

          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
            cd /var/www/tripsalama

            # Verifier si Docker est utilise
            if docker ps 2>/dev/null | grep -q tripsalama-db; then
              echo "Using Docker MySQL container..."

              # Executer via Docker
              docker cp /tmp/${{ github.event.inputs.migration_file }} tripsalama-db:/tmp/migration.sql
              docker exec tripsalama-db sh -c "mysql -u root -p\$MYSQL_ROOT_PASSWORD tripsalama < /tmp/migration.sql"

              if [ $? -eq 0 ]; then
                echo "Migration completed successfully!"

                # Verifier
                echo "Verifying new columns:"
                docker exec tripsalama-db sh -c "mysql -u root -p\$MYSQL_ROOT_PASSWORD tripsalama -e \"DESCRIBE users;\"" | grep identity || echo "No identity columns"

                echo "Verifying new table:"
                docker exec tripsalama-db sh -c "mysql -u root -p\$MYSQL_ROOT_PASSWORD tripsalama -e \"SHOW TABLES LIKE '\''identity%'\'';\""
              else
                echo "Docker migration failed!"
                exit 1
              fi
            else
              echo "Using native MySQL..."

              # Charger .env
              if [ -f .env ]; then
                set -a
                source .env
                set +a
              fi

              # Creer fichier de config MySQL temporaire pour eviter problemes d echappement
              echo "[client]" > /tmp/.my.cnf
              echo "user=${DB_USER:-tripsalama}" >> /tmp/.my.cnf
              echo "password=${DB_PASSWORD}" >> /tmp/.my.cnf
              echo "host=${DB_HOST:-127.0.0.1}" >> /tmp/.my.cnf
              chmod 600 /tmp/.my.cnf

              echo "Running migration: ${{ github.event.inputs.migration_file }}"

              if mysql --defaults-file=/tmp/.my.cnf ${DB_NAME:-tripsalama} < /tmp/${{ github.event.inputs.migration_file }}; then
                echo "Migration completed successfully!"

                echo "Verifying new columns:"
                mysql --defaults-file=/tmp/.my.cnf ${DB_NAME:-tripsalama} -e "DESCRIBE users;" | grep identity || echo "No identity columns"

                echo "Verifying new table:"
                mysql --defaults-file=/tmp/.my.cnf ${DB_NAME:-tripsalama} -e "SHOW TABLES LIKE '\''identity%'\'';"

                rm -f /tmp/.my.cnf
              else
                rm -f /tmp/.my.cnf
                echo "Native MySQL migration failed!"
                exit 1
              fi
            fi

            # Nettoyer
            rm -f /tmp/${{ github.event.inputs.migration_file }}
          '

      - name: Create uploads directory
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            mkdir -p ${{ env.REMOTE_PATH }}/public/uploads/verifications
            chmod 755 ${{ env.REMOTE_PATH }}/public/uploads/verifications
            echo 'Uploads directory created'
          "

      - name: Summary
        run: |
          echo "## Migration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Migration File | ${{ github.event.inputs.migration_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Completed |" >> $GITHUB_STEP_SUMMARY
