name: Run Database Migration

on:
  workflow_dispatch:
    inputs:
      migration_file:
        description: 'Migration file to run (e.g., 006_identity_verification.sql)'
        required: true
        default: '006_identity_verification.sql'

env:
  VPS_HOST: '83.228.205.222'
  VPS_USER: 'debian'
  REMOTE_PATH: '/var/www/tripsalama'

jobs:
  run-migration:
    runs-on: ubuntu-latest
    name: "Run Migration on VPS"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Upload migration file
        run: |
          scp database/migrations/${{ github.event.inputs.migration_file }} \
            ${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/

      - name: Debug and Run migration
        run: |
          # Debugger les variables .env disponibles sur le VPS
          echo "=== Debugging .env variables on VPS ==="
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
            cd /var/www/tripsalama
            echo "Contents of .env (DB related, masked):"
            if [ -f .env ]; then
              grep -E "^(DB_|MYSQL_)" .env | sed "s/=.*/=***/"
            else
              echo "No .env file found!"
              ls -la
            fi
          '

          # ExÃ©cuter la migration avec les credentials du VPS
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
            cd /var/www/tripsalama

            # Charger les variables d environnement
            if [ -f .env ]; then
              set -a
              source .env
              set +a
            fi

            # Debug: montrer les variables (masquees)
            echo "DB_HOST=$DB_HOST"
            echo "DB_USER=$DB_USER"
            echo "DB_NAME=$DB_NAME"
            echo "DB_PASSWORD length: ${#DB_PASSWORD}"
            echo "MYSQL_PASSWORD length: ${#MYSQL_PASSWORD}"

            # Utiliser MYSQL_PASSWORD si DB_PASSWORD vide
            FINAL_PASSWORD="${DB_PASSWORD:-${MYSQL_PASSWORD:-${MYSQL_ROOT_PASSWORD}}}"

            echo "Running migration: ${{ github.event.inputs.migration_file }}"
            echo "Using DB: ${DB_NAME:-tripsalama} on ${DB_HOST:-127.0.0.1} as ${DB_USER:-tripsalama}"

            # Executer la migration
            if mysql -h "${DB_HOST:-127.0.0.1}" -u "${DB_USER:-tripsalama}" -p"$FINAL_PASSWORD" "${DB_NAME:-tripsalama}" < /tmp/${{ github.event.inputs.migration_file }}; then
              echo "Migration completed successfully!"

              # Verifier les nouvelles colonnes
              echo "Verifying new columns in users table:"
              mysql -h "${DB_HOST:-127.0.0.1}" -u "${DB_USER:-tripsalama}" -p"$FINAL_PASSWORD" "${DB_NAME:-tripsalama}" -e "DESCRIBE users;" | grep identity || echo "No identity columns yet"

              # Verifier la nouvelle table
              echo "Verifying identity_verifications table:"
              mysql -h "${DB_HOST:-127.0.0.1}" -u "${DB_USER:-tripsalama}" -p"$FINAL_PASSWORD" "${DB_NAME:-tripsalama}" -e "SHOW TABLES LIKE '\''identity%'\'';"
            else
              echo "Migration failed!"
              exit 1
            fi

            # Nettoyer
            rm -f /tmp/${{ github.event.inputs.migration_file }}
          '

      - name: Create uploads directory
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            mkdir -p ${{ env.REMOTE_PATH }}/public/uploads/verifications
            chmod 755 ${{ env.REMOTE_PATH }}/public/uploads/verifications
            echo 'Uploads directory created'
          "

      - name: Summary
        run: |
          echo "## Migration Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Migration File | ${{ github.event.inputs.migration_file }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Completed |" >> $GITHUB_STEP_SUMMARY
