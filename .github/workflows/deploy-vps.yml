name: Deploy TripSalama to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '83.228.205.222'
  VPS_USER: 'debian'
  REMOTE_PATH: '/var/www/tripsalama'
  BASE_PATH: '/internal/tripsalama'
  PHP_VERSION: '8.4'

jobs:
  # ========================================
  # PHASE 1: VALIDATION
  # ========================================
  validate:
    runs-on: ubuntu-latest
    name: "Validate PHP"
    outputs:
      valid: ${{ steps.lint.outputs.valid }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Validate PHP syntax
        id: lint
        run: |
          ERRORS=0
          CHECKED=0

          for dir in backend/php public; do
            if [ -d "$dir" ]; then
              while IFS= read -r -d '' file; do
                ((CHECKED++)) || true
                if ! php -l "$file" > /dev/null 2>&1; then
                  echo "::error file=$file::PHP syntax error"
                  ((ERRORS++)) || true
                fi
              done < <(find "$dir" -name "*.php" -o -name "*.phtml" -print0 2>/dev/null)
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "::notice::$CHECKED PHP files validated"

  # ========================================
  # PHASE 2: DEPLOY
  # ========================================
  deploy:
    runs-on: ubuntu-latest
    name: "Deploy to VPS"
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    outputs:
      success: ${{ steps.verify.outputs.success }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 30
            ServerAliveInterval 10
            BatchMode yes
            LogLevel ERROR
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          for attempt in 1 2 3; do
            if ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK'"; then
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: Create directories on VPS
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            sudo mkdir -p ${{ env.REMOTE_PATH }}
            sudo mkdir -p ${{ env.REMOTE_PATH }}/public/uploads
            sudo chown -R debian:debian ${{ env.REMOTE_PATH }}
          "

      - name: Create backend directory structure
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            mkdir -p ${{ env.REMOTE_PATH }}/backend/php
          "

      - name: Deploy backend files
        run: |
          echo "Deploying backend..."

          # Deploy entire backend/php directory with proper structure
          rsync -avz --delete \
            -e "ssh" \
            "backend/php/" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/backend/php/"

          echo "Backend deployed with bootstrap.php"

      - name: Deploy public files
        run: |
          echo "Deploying public files..."

          rsync -avz --delete \
            --exclude='uploads/' \
            -e "ssh" \
            "public/" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/public/"

      - name: Deploy database migrations
        run: |
          if [ -d "database" ]; then
            rsync -avz \
              -e "ssh" \
              "database/" \
              "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/database/"
          fi

      - name: Setup MySQL user and database
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
            echo "=== Setting up MySQL for TripSalama ==="

            # Create database if not exists
            sudo mysql -e "CREATE DATABASE IF NOT EXISTS tripsalama CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

            # Create user with password (drop and recreate to ensure correct password)
            sudo mysql -e "DROP USER IF EXISTS '"'"'tripsalama'"'"'@'"'"'localhost'"'"';"
            sudo mysql -e "CREATE USER '"'"'tripsalama'"'"'@'"'"'localhost'"'"' IDENTIFIED BY '"'"'TripSalama2025!'"'"';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON tripsalama.* TO '"'"'tripsalama'"'"'@'"'"'localhost'"'"';"
            sudo mysql -e "FLUSH PRIVILEGES;"

            echo "MySQL user tripsalama created with privileges"

            # Run migrations if they exist
            if [ -f /var/www/tripsalama/database/migrations/006_identity_verification.sql ]; then
              echo "Running identity verification migration..."
              sudo mysql tripsalama < /var/www/tripsalama/database/migrations/006_identity_verification.sql 2>/dev/null || echo "Migration already applied or skipped"
            fi

            # Mark all pending/in_progress rides as completed
            echo "=== Cleaning up rides ==="
            sudo mysql tripsalama -e "UPDATE rides SET status = '"'"'completed'"'"', completed_at = NOW() WHERE status IN ('"'"'pending'"'"', '"'"'accepted'"'"', '"'"'driver_arriving'"'"', '"'"'in_progress'"'"');"
            echo "All pending rides marked as completed"
          '

      - name: Create production config
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            # Create .env for production
            cat > ${{ env.REMOTE_PATH }}/.env << 'EOF'
          APP_ENV=production
          APP_DEBUG=false
          BASE_PATH=/internal/tripsalama

          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=tripsalama
          DB_USERNAME=tripsalama
          DB_PASSWORD=TripSalama2025!
          EOF

            # Create .production marker
            touch ${{ env.REMOTE_PATH }}/.production
          "

      - name: Fix permissions
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            sudo chown -R www-data:www-data ${{ env.REMOTE_PATH }}
            sudo chmod -R 755 ${{ env.REMOTE_PATH }}
            sudo chmod -R 777 ${{ env.REMOTE_PATH }}/public/uploads
          "

      - name: Deploy TripSalama nginx snippet
        run: |
          echo "=============================================="
          echo "TRIPSALAMA NGINX SNIPPET DEPLOYMENT"
          echo "=============================================="
          echo ""
          echo "IMPORTANT: TripSalama ONLY manages its own snippet file."
          echo "The main nginx config is managed by the Helios project."
          echo "TripSalama will NEVER modify the main nginx config."
          echo ""

          # Deploy snippet file to VPS
          scp -o StrictHostKeyChecking=no \
            "docker/nginx-tripsalama.conf" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/tripsalama.conf"

          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} 'bash -s' << 'ENDSSH'
            set -e

            # Create snippets directory if not exists
            sudo mkdir -p /etc/nginx/snippets

            # Deploy TripSalama snippet ONLY - DO NOT touch main nginx config
            sudo cp /tmp/tripsalama.conf /etc/nginx/snippets/tripsalama.conf
            sudo chown root:root /etc/nginx/snippets/tripsalama.conf
            sudo chmod 644 /etc/nginx/snippets/tripsalama.conf
            echo "✅ Deployed /etc/nginx/snippets/tripsalama.conf"

            # Show snippet content
            echo ""
            echo "=== Snippet content ==="
            cat /etc/nginx/snippets/tripsalama.conf

            # Check if main nginx config includes the snippet (info only, don't modify)
            echo ""
            echo "=== Checking main nginx config ==="
            NGINX_CONFIG="/etc/nginx/sites-enabled/helios"
            if [ -f "$NGINX_CONFIG" ]; then
              if grep -q "include /etc/nginx/snippets/tripsalama.conf" "$NGINX_CONFIG"; then
                echo "✅ Main nginx config includes TripSalama snippet"
                grep -n "tripsalama" "$NGINX_CONFIG"
              else
                echo "⚠️ WARNING: Main nginx config does NOT include TripSalama snippet!"
                echo "   Run Helios deployment to update the main nginx config."
                echo "   TripSalama does NOT and will NEVER modify the main nginx config."
              fi
            else
              echo "⚠️ Main nginx config not found at $NGINX_CONFIG"
              echo "   Helios must be deployed first to set up the main nginx config."
            fi

            # Test nginx syntax (if config exists and includes snippet)
            echo ""
            echo "=== Testing nginx config ==="
            if sudo nginx -t 2>&1; then
              echo "✅ Nginx syntax OK - reloading..."
              sudo systemctl reload nginx
              echo "✅ Nginx reloaded"
            else
              echo "⚠️ Nginx syntax error"
              echo "   This may be because the main nginx config doesn't include the snippet yet."
              echo "   Deploy Helios first to set up the main nginx config."
              # Don't exit with error - the snippet itself is valid
            fi
          ENDSSH

      - name: Verify deployment
        id: verify
        run: |
          sleep 3

          echo "=== Deployment Verification ==="

          # Show .env file (redact password)
          echo "--- .env file (redacted) ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cat ${{ env.REMOTE_PATH }}/.env | sed 's/DB_PASSWORD=.*/DB_PASSWORD=***REDACTED***/'"

          # Check directory structure
          echo "--- Directory structure ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "ls -la ${{ env.REMOTE_PATH }}/public/ | head -15"

          # Check index.php exists
          echo "--- Checking index.php ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "head -5 ${{ env.REMOTE_PATH }}/public/index.php 2>/dev/null || echo 'index.php NOT FOUND!'"

          # Check HTTP response - internal (via localhost)
          echo "--- HTTP Check (internal via localhost) ---"
          HTTP=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -skL -o /dev/null -w '%{http_code}' http://127.0.0.1${{ env.BASE_PATH }}/login")
          echo "HTTP Status (localhost, following redirects): $HTTP"

          # Check HTTP response - external (via domain)
          echo "--- HTTP Check (external via domain) ---"
          HTTP_EXT=$(curl -skL -o /dev/null -w '%{http_code}' "https://stabilis-it.ch${{ env.BASE_PATH }}/login")
          echo "HTTP Status (external): $HTTP_EXT"

          # Check if external request is being redirected elsewhere
          echo "--- Redirect check ---"
          REDIRECT_URL=$(curl -sk -o /dev/null -w '%{redirect_url}' "https://stabilis-it.ch${{ env.BASE_PATH }}/")
          if [ -n "$REDIRECT_URL" ]; then
            echo "Redirects to: $REDIRECT_URL"
            if echo "$REDIRECT_URL" | grep -qv "tripsalama"; then
              echo "WARNING: Redirect goes outside tripsalama!"
            fi
          else
            echo "No redirect (good)"
          fi

          # If error, show logs
          if [ "$HTTP" = "500" ] || [ "$HTTP" = "404" ] || [ "$HTTP" = "502" ]; then
            echo "=== Error Logs ==="
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "sudo tail -30 /var/log/nginx/error.log 2>/dev/null | grep -i tripsalama || sudo tail -20 /var/log/nginx/error.log"
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "sudo tail -10 /var/log/php8.4-fpm.log 2>/dev/null || echo 'No PHP-FPM log'"
          fi

          # Check nginx config is valid
          echo "--- Nginx TripSalama config ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cat /etc/nginx/snippets/tripsalama.conf 2>/dev/null | head -20 || echo 'Config not found'"

          # Verify with curl verbose for debugging
          if [ "$HTTP" != "200" ]; then
            echo "--- Curl verbose debug ---"
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -svk http://127.0.0.1${{ env.BASE_PATH }}/ 2>&1 | head -30"
          fi

          # Success conditions: both internal and external must return 200, 301, or 302
          if [ "$HTTP" = "200" ] || [ "$HTTP" = "301" ] || [ "$HTTP" = "302" ]; then
            if [ "$HTTP_EXT" = "200" ] || [ "$HTTP_EXT" = "301" ] || [ "$HTTP_EXT" = "302" ]; then
              echo "success=true" >> $GITHUB_OUTPUT
              echo "::notice::Deployment verified (internal: $HTTP, external: $HTTP_EXT)"
            else
              echo "success=false" >> $GITHUB_OUTPUT
              echo "::error::External access failed (internal: $HTTP, external: $HTTP_EXT)"
              exit 1
            fi
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "::error::Internal access failed (HTTP $HTTP)"
            exit 1
          fi

  # ========================================
  # SUMMARY
  # ========================================
  summary:
    runs-on: ubuntu-latest
    name: "Summary"
    needs: [validate, deploy]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## TripSalama Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.outputs.valid == 'true' && 'OK' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.outputs.success == 'true' && 'OK' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://stabilis-it.ch/internal/tripsalama" >> $GITHUB_STEP_SUMMARY
