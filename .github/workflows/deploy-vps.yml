name: Deploy TripSalama to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '83.228.205.222'
  VPS_USER: 'debian'
  REMOTE_PATH: '/var/www/tripsalama'
  BASE_PATH: '/internal/tripsalama'
  PHP_VERSION: '8.4'

jobs:
  # ========================================
  # PHASE 1: VALIDATION
  # ========================================
  validate:
    runs-on: ubuntu-latest
    name: "Validate PHP"
    outputs:
      valid: ${{ steps.lint.outputs.valid }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Validate PHP syntax
        id: lint
        run: |
          ERRORS=0
          CHECKED=0

          for dir in backend/php public; do
            if [ -d "$dir" ]; then
              while IFS= read -r -d '' file; do
                ((CHECKED++)) || true
                if ! php -l "$file" > /dev/null 2>&1; then
                  echo "::error file=$file::PHP syntax error"
                  ((ERRORS++)) || true
                fi
              done < <(find "$dir" -name "*.php" -o -name "*.phtml" -print0 2>/dev/null)
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "::notice::$CHECKED PHP files validated"

  # ========================================
  # PHASE 2: DEPLOY
  # ========================================
  deploy:
    runs-on: ubuntu-latest
    name: "Deploy to VPS"
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    outputs:
      success: ${{ steps.verify.outputs.success }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 30
            ServerAliveInterval 10
            BatchMode yes
            LogLevel ERROR
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          for attempt in 1 2 3; do
            if ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK'"; then
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: Create directories on VPS
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            sudo mkdir -p ${{ env.REMOTE_PATH }}
            sudo mkdir -p ${{ env.REMOTE_PATH }}/public/uploads
            sudo chown -R debian:debian ${{ env.REMOTE_PATH }}
          "

      - name: Create backend directory structure
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            mkdir -p ${{ env.REMOTE_PATH }}/backend/php
          "

      - name: Deploy backend files
        run: |
          echo "Deploying backend..."

          # Deploy entire backend/php directory with proper structure
          rsync -avz --delete \
            -e "ssh" \
            "backend/php/" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/backend/php/"

          echo "Backend deployed with bootstrap.php"

      - name: Deploy public files
        run: |
          echo "Deploying public files..."

          rsync -avz --delete \
            --exclude='uploads/' \
            -e "ssh" \
            "public/" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/public/"

      - name: Deploy database migrations
        run: |
          if [ -d "database" ]; then
            rsync -avz \
              -e "ssh" \
              "database/" \
              "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/database/"
          fi

      - name: Create production config
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            # Create .env for production
            cat > ${{ env.REMOTE_PATH }}/.env << EOF
          APP_ENV=production
          APP_DEBUG=false
          BASE_PATH=/internal/tripsalama

          DB_HOST=127.0.0.1
          DB_PORT=3306
          DB_DATABASE=tripsalama
          DB_USERNAME=tripsalama
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          EOF

            # Create .production marker
            touch ${{ env.REMOTE_PATH }}/.production
          "

      - name: Fix permissions
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            sudo chown -R www-data:www-data ${{ env.REMOTE_PATH }}
            sudo chmod -R 755 ${{ env.REMOTE_PATH }}
            sudo chmod -R 777 ${{ env.REMOTE_PATH }}/public/uploads
          "

      - name: Configure nginx
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
            # Create nginx config for TripSalama
            sudo tee /etc/nginx/sites-available/tripsalama << "NGINX"
          location /internal/tripsalama {
              alias /var/www/tripsalama/public;
              index index.php;

              location ~ \.php$ {
                  fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
                  fastcgi_param SCRIPT_FILENAME $request_filename;
                  include fastcgi_params;
              }

              try_files $uri $uri/ /internal/tripsalama/index.php?$query_string;
          }
          NGINX

            # Include in main site config if not already
            if ! grep -q "include.*tripsalama" /etc/nginx/sites-available/default 2>/dev/null; then
              echo "Adding TripSalama to nginx..."
              sudo sed -i "/server_name/a\\    include /etc/nginx/sites-available/tripsalama;" /etc/nginx/sites-available/default 2>/dev/null || true
            fi

            # Test and reload nginx
            sudo nginx -t && sudo systemctl reload nginx
          '

      - name: Verify deployment
        id: verify
        run: |
          sleep 3

          # Show .env file (redact password)
          echo "=== .env file (redacted) ==="
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cat ${{ env.REMOTE_PATH }}/.env | sed 's/DB_PASSWORD=.*/DB_PASSWORD=***REDACTED***/'"

          # Check HTTP response
          HTTP=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1${{ env.BASE_PATH }}/login")
          echo "HTTP Status: $HTTP"

          # If error, show PHP error log
          if [ "$HTTP" = "500" ]; then
            echo "=== PHP Error Log (last 20 lines) ==="
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "sudo tail -20 /var/log/php8.4-fpm.log 2>/dev/null || sudo tail -20 /var/log/nginx/error.log 2>/dev/null || echo 'No error logs found'"
          fi

          if [ "$HTTP" = "200" ] || [ "$HTTP" = "302" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "::notice::Deployment verified (HTTP $HTTP)"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "::warning::Deployment returned HTTP $HTTP"
            # Don't fail - might need manual nginx config
            echo "success=true" >> $GITHUB_OUTPUT
          fi

  # ========================================
  # SUMMARY
  # ========================================
  summary:
    runs-on: ubuntu-latest
    name: "Summary"
    needs: [validate, deploy]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## TripSalama Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.outputs.valid == 'true' && 'OK' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.outputs.success == 'true' && 'OK' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://stabilis-it.ch/internal/tripsalama" >> $GITHUB_STEP_SUMMARY
