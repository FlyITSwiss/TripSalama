name: Deploy TripSalama to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  VPS_HOST: '83.228.205.222'
  VPS_USER: 'debian'
  REMOTE_PATH: '/var/www/tripsalama'
  BASE_PATH: '/internal/tripsalama'
  PHP_VERSION: '8.4'

jobs:
  # ========================================
  # PHASE 1: VALIDATION
  # ========================================
  validate:
    runs-on: ubuntu-latest
    name: "Validate PHP"
    outputs:
      valid: ${{ steps.lint.outputs.valid }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Validate PHP syntax
        id: lint
        run: |
          ERRORS=0
          CHECKED=0

          for dir in backend/php public; do
            if [ -d "$dir" ]; then
              while IFS= read -r -d '' file; do
                ((CHECKED++)) || true
                if ! php -l "$file" > /dev/null 2>&1; then
                  echo "::error file=$file::PHP syntax error"
                  ((ERRORS++)) || true
                fi
              done < <(find "$dir" -name "*.php" -o -name "*.phtml" -print0 2>/dev/null)
            fi
          done

          if [ "$ERRORS" -gt 0 ]; then
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "valid=true" >> $GITHUB_OUTPUT
          echo "::notice::$CHECKED PHP files validated"

  # ========================================
  # PHASE 2: DEPLOY
  # ========================================
  deploy:
    runs-on: ubuntu-latest
    name: "Deploy to VPS"
    needs: validate
    if: needs.validate.outputs.valid == 'true'
    outputs:
      success: ${{ steps.verify.outputs.success }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat > ~/.ssh/config << 'SSHCONFIG'
          Host *
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ConnectTimeout 30
            ServerAliveInterval 10
            BatchMode yes
            LogLevel ERROR
          SSHCONFIG
          chmod 600 ~/.ssh/config

      - name: Test SSH connection
        run: |
          for attempt in 1 2 3; do
            if ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "echo 'SSH OK'"; then
              exit 0
            fi
            sleep 5
          done
          exit 1

      - name: Create directories on VPS
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            sudo mkdir -p ${{ env.REMOTE_PATH }}
            sudo mkdir -p ${{ env.REMOTE_PATH }}/public/uploads
            sudo chown -R debian:debian ${{ env.REMOTE_PATH }}
          "

      - name: Create backend directory structure
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            mkdir -p ${{ env.REMOTE_PATH }}/backend/php
          "

      - name: Deploy backend files
        run: |
          echo "Deploying backend..."

          # Deploy entire backend/php directory with proper structure
          rsync -avz --delete \
            -e "ssh" \
            "backend/php/" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/backend/php/"

          echo "Backend deployed with bootstrap.php"

      - name: Deploy public files
        run: |
          echo "Deploying public files..."

          rsync -avz --delete \
            --exclude='uploads/' \
            -e "ssh" \
            "public/" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/public/"

      - name: Deploy database migrations
        run: |
          if [ -d "database" ]; then
            rsync -avz \
              -e "ssh" \
              "database/" \
              "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:${{ env.REMOTE_PATH }}/database/"
          fi

      - name: Setup MySQL user and database
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} '
            echo "=== Setting up MySQL for TripSalama ==="

            # Create database if not exists
            sudo mysql -e "CREATE DATABASE IF NOT EXISTS tripsalama CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"

            # Create user with password (drop and recreate to ensure correct password)
            sudo mysql -e "DROP USER IF EXISTS '"'"'tripsalama'"'"'@'"'"'localhost'"'"';"
            sudo mysql -e "CREATE USER '"'"'tripsalama'"'"'@'"'"'localhost'"'"' IDENTIFIED BY '"'"'TripSalama2025!'"'"';"
            sudo mysql -e "GRANT ALL PRIVILEGES ON tripsalama.* TO '"'"'tripsalama'"'"'@'"'"'localhost'"'"';"
            sudo mysql -e "FLUSH PRIVILEGES;"

            echo "MySQL user tripsalama created with privileges"

            # Run migrations if they exist
            if [ -f /var/www/tripsalama/database/migrations/006_identity_verification.sql ]; then
              echo "Running identity verification migration..."
              sudo mysql tripsalama < /var/www/tripsalama/database/migrations/006_identity_verification.sql 2>/dev/null || echo "Migration already applied or skipped"
            fi

            # Mark all pending/in_progress rides as completed
            echo "=== Cleaning up rides ==="
            sudo mysql tripsalama -e "UPDATE rides SET status = '"'"'completed'"'"', completed_at = NOW() WHERE status IN ('"'"'pending'"'"', '"'"'accepted'"'"', '"'"'driver_arriving'"'"', '"'"'in_progress'"'"');"
            echo "All pending rides marked as completed"
          '

      - name: Create production config
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            # Create .env for production
            cat > ${{ env.REMOTE_PATH }}/.env << 'EOF'
          APP_ENV=production
          APP_DEBUG=false
          BASE_PATH=/internal/tripsalama

          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=tripsalama
          DB_USERNAME=tripsalama
          DB_PASSWORD=TripSalama2025!
          EOF

            # Create .production marker
            touch ${{ env.REMOTE_PATH }}/.production
          "

      - name: Fix permissions
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "
            sudo chown -R www-data:www-data ${{ env.REMOTE_PATH }}
            sudo chmod -R 755 ${{ env.REMOTE_PATH }}
            sudo chmod -R 777 ${{ env.REMOTE_PATH }}/public/uploads
          "

      - name: Deploy nginx config
        run: |
          echo "Deploying nginx config file..."
          scp -o StrictHostKeyChecking=no \
            "docker/nginx-tripsalama.conf" \
            "${{ env.VPS_USER }}@${{ env.VPS_HOST }}:/tmp/tripsalama.conf"

      - name: Configure nginx
        run: |
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} 'bash -s' << 'ENDSSH'
            echo "=== Configuring nginx for TripSalama ==="

            # Move nginx config to snippets
            sudo mkdir -p /etc/nginx/snippets
            sudo cp /tmp/tripsalama.conf /etc/nginx/snippets/tripsalama.conf
            echo "Created /etc/nginx/snippets/tripsalama.conf"

            # Find the active nginx config (Certbot-managed)
            NGINX_CONFIG=""
            if [ -f /etc/nginx/sites-enabled/helios ]; then
              NGINX_CONFIG="/etc/nginx/sites-enabled/helios"
              echo "Found Certbot-managed config: $NGINX_CONFIG"
            elif [ -f /etc/nginx/sites-available/stabilis-it.ch ]; then
              NGINX_CONFIG="/etc/nginx/sites-available/stabilis-it.ch"
            elif [ -f /etc/nginx/sites-available/default ]; then
              NGINX_CONFIG="/etc/nginx/sites-available/default"
            fi

            if [ -z "$NGINX_CONFIG" ]; then
              echo "No nginx config found!"
              exit 1
            fi

            echo "Using nginx config: $NGINX_CONFIG"

            # Backup config
            sudo cp "$NGINX_CONFIG" /tmp/nginx-tripsalama-backup.conf

            # FIRST: Remove any existing inline TripSalama location blocks (cleanup old config)
            # This prevents "duplicate location" errors
            if grep -q "location /internal/tripsalama" "$NGINX_CONFIG"; then
              echo "Removing old inline TripSalama config..."
              # Remove lines between "location /internal/tripsalama" and closing brace
              sudo sed -i '/location \/internal\/tripsalama/,/^[[:space:]]*}/d' "$NGINX_CONFIG"
              echo "Old config removed"
            fi

            # Check if TripSalama snippet is already included
            if grep -q "include.*snippets/tripsalama" "$NGINX_CONFIG"; then
              echo "TripSalama snippet already included in nginx config"
            else
              echo "Adding TripSalama include to nginx config..."
              sudo sed -i '/server_name.*stabilis-it.ch/a\    include /etc/nginx/snippets/tripsalama.conf;' "$NGINX_CONFIG" 2>/dev/null || \
              sudo sed -i '/server_name/a\    include /etc/nginx/snippets/tripsalama.conf;' "$NGINX_CONFIG"
              echo "Added TripSalama include"
            fi

            # Test nginx syntax
            if sudo nginx -t 2>&1; then
              echo "Nginx syntax OK"
              sudo systemctl reload nginx
              echo "Nginx reloaded"
            else
              echo "Nginx syntax error - restoring backup"
              sudo cp /tmp/nginx-tripsalama-backup.conf "$NGINX_CONFIG"
              sudo nginx -t && sudo systemctl reload nginx
              echo "Restored original config"
              exit 1
            fi

            # Show final config
            echo "=== TripSalama in nginx ==="
            grep -n "tripsalama" "$NGINX_CONFIG" | head -5
          ENDSSH

      - name: Verify deployment
        id: verify
        run: |
          sleep 3

          echo "=== Deployment Verification ==="

          # Show .env file (redact password)
          echo "--- .env file (redacted) ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cat ${{ env.REMOTE_PATH }}/.env | sed 's/DB_PASSWORD=.*/DB_PASSWORD=***REDACTED***/'"

          # Check directory structure
          echo "--- Directory structure ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "ls -la ${{ env.REMOTE_PATH }}/public/ | head -15"

          # Check index.php exists
          echo "--- Checking index.php ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "head -5 ${{ env.REMOTE_PATH }}/public/index.php 2>/dev/null || echo 'index.php NOT FOUND!'"

          # Check HTTP response with follow redirects
          echo "--- HTTP Check ---"
          HTTP=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -sL -o /dev/null -w '%{http_code}' http://127.0.0.1${{ env.BASE_PATH }}/login")
          echo "HTTP Status (following redirects): $HTTP"

          # Also check without following redirects
          HTTP_DIRECT=$(ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1${{ env.BASE_PATH }}/login")
          echo "HTTP Status (direct): $HTTP_DIRECT"

          # If error, show logs
          if [ "$HTTP" = "500" ] || [ "$HTTP" = "404" ] || [ "$HTTP" = "502" ]; then
            echo "=== Error Logs ==="
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "sudo tail -30 /var/log/nginx/error.log 2>/dev/null | grep -i tripsalama || sudo tail -20 /var/log/nginx/error.log"
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "sudo tail -10 /var/log/php8.4-fpm.log 2>/dev/null || echo 'No PHP-FPM log'"
          fi

          # Check nginx config is valid
          echo "--- Nginx TripSalama config ---"
          ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "cat /etc/nginx/snippets/tripsalama.conf 2>/dev/null | head -20 || echo 'Config not found'"

          # Verify with curl verbose for debugging
          if [ "$HTTP" != "200" ]; then
            echo "--- Curl verbose debug ---"
            ssh ${{ env.VPS_USER }}@${{ env.VPS_HOST }} "curl -sv http://127.0.0.1${{ env.BASE_PATH }}/ 2>&1 | head -30"
          fi

          # Success conditions: 200, 301, 302 are all OK
          if [ "$HTTP" = "200" ] || [ "$HTTP" = "301" ] || [ "$HTTP" = "302" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "::notice::Deployment verified (HTTP $HTTP)"
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "::error::Deployment verification failed (HTTP $HTTP)"
            exit 1
          fi

  # ========================================
  # SUMMARY
  # ========================================
  summary:
    runs-on: ubuntu-latest
    name: "Summary"
    needs: [validate, deploy]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "## TripSalama Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Phase | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Validation | ${{ needs.validate.outputs.valid == 'true' && 'OK' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.outputs.success == 'true' && 'OK' || 'FAIL' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://stabilis-it.ch/internal/tripsalama" >> $GITHUB_STEP_SUMMARY
