name: TripSalama CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '20'

jobs:
  # Job 1: Lint and validate
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer

      - name: Validate PHP syntax
        run: |
          find backend/php -name "*.php" -exec php -l {} \;
          find public -name "*.php" -exec php -l {} \;

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress

      - name: Run PHPStan
        run: vendor/bin/phpstan analyse --configuration=phpstan.neon --no-progress

      - name: Check for hardcoded French text
        run: |
          ! grep -rE "'(Erreur|Succ√®s|Veuillez|Chargement)[^']*'" --include="*.php" --include="*.phtml" --include="*.js" backend/ public/ | grep -v '__(' || true

      - name: Check for missing accents
        run: |
          ! grep -rE "'(cree|creee|mise a jour|succes|resultat|termine|echoue)'" --include="*.php" --include="*.phtml" backend/ public/ || true

  # Job 2: E2E Tests with Puppeteer
  test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: lint

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: tripsalama
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: pdo, pdo_mysql, mbstring, json

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Puppeteer dependencies
        run: |
          cd tests/puppeteer
          npm install

      - name: Create .env file
        run: |
          cp .env.example .env
          sed -i 's/DB_HOST=.*/DB_HOST=127.0.0.1/' .env
          sed -i 's/DB_PASSWORD=.*/DB_PASSWORD=root/' .env

      - name: Run migrations
        run: |
          mysql -h 127.0.0.1 -u root -proot tripsalama < database/migrations/001_create_users_table.sql
          mysql -h 127.0.0.1 -u root -proot tripsalama < database/migrations/002_create_vehicles_table.sql
          mysql -h 127.0.0.1 -u root -proot tripsalama < database/migrations/003_create_rides_table.sql
          mysql -h 127.0.0.1 -u root -proot tripsalama < database/migrations/004_create_ratings_table.sql
          mysql -h 127.0.0.1 -u root -proot tripsalama < database/migrations/005_create_sessions_table.sql
          mysql -h 127.0.0.1 -u root -proot tripsalama < database/seeds/demo_data.sql

      - name: Start PHP server
        run: |
          php -S 127.0.0.1:8080 -t public &
          sleep 5

      - name: Run Puppeteer tests
        run: |
          cd tests/puppeteer
          npm run test:smoke

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: puppeteer-screenshots
          path: tests/puppeteer/screenshots/
          retention-days: 7

  # Job 3: Deploy to staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          tar -czf tripsalama.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='docker' \
            --exclude='.env' \
            --exclude='*.log' \
            .

      - name: Deploy to staging
        env:
          DEPLOY_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          echo "Deploying to staging..."
          # Add SSH deploy commands here

  # Job 4: Deploy to production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          tar -czf tripsalama.tar.gz \
            --exclude='.git' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='docker' \
            --exclude='.env' \
            --exclude='*.log' \
            .

      - name: Deploy to Infomaniak
        env:
          FTP_HOST: ${{ secrets.INFOMANIAK_FTP_HOST }}
          FTP_USER: ${{ secrets.INFOMANIAK_FTP_USER }}
          FTP_PASSWORD: ${{ secrets.INFOMANIAK_FTP_PASSWORD }}
        run: |
          echo "Deploying to Infomaniak..."
          # Install lftp for FTP deployment
          sudo apt-get install -y lftp

          lftp -c "
            set ftp:ssl-allow no;
            open -u $FTP_USER,$FTP_PASSWORD $FTP_HOST;
            cd /web;
            put tripsalama.tar.gz;
            bye
          "

          echo "Package uploaded. Manual extraction may be required."
