# ================================================
# TripSalama - Nginx Configuration Snippet
# PHP 8.4 FPM - Alias-based routing
# ================================================
# IMPORTANT: This file is managed by TripSalama project
# It is included by the main Helios nginx config
# DO NOT add server blocks here, only location blocks
# ================================================

# TripSalama application
# ^~ prefix ensures this location takes priority over regex locations
location ^~ /internal/tripsalama {
    alias /var/www/tripsalama/public;
    index index.php;

    # Static files - serve directly with caching
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # PHP files processing
    location ~ \.php$ {
        # Calculate the actual file path for alias
        set $script_path /var/www/tripsalama/public;
        if ($uri ~ "^/internal/tripsalama/(.*)$") {
            set $script_path /var/www/tripsalama/public/$1;
        }

        # FastCGI configuration
        fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $script_path;
        fastcgi_param DOCUMENT_ROOT /var/www/tripsalama/public;
        fastcgi_param REQUEST_URI $request_uri;

        # Override parent Permissions-Policy to allow geolocation for TripSalama
        # Note: Any add_header in location block clears parent add_headers,
        # but PHP (SecurityHeadersMiddleware) sets all other security headers
        add_header Permissions-Policy "accelerometer=(), camera=*, geolocation=*, gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;

        # Timeouts for long-running scripts
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
    }

    # Front controller pattern - route all non-file requests to index.php
    try_files $uri $uri/ @tripsalama_php;
}

# Named location for TripSalama front controller
location @tripsalama_php {
    rewrite ^/internal/tripsalama/(.*)$ /internal/tripsalama/index.php?$query_string last;
}
