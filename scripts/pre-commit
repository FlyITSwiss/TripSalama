#!/bin/bash
# TripSalama - Pre-commit Hook
# Install√© automatiquement par scripts/setup.sh

set -e

echo "üîç TripSalama Pre-commit Hook"
echo "=============================="

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

ERRORS=0

# 1. V√©rifier console.log en production (ignorer tests/)
echo -n "1. Checking for console.log... "
CONSOLE_LOGS=$(git diff --cached --name-only | grep -E '\.js$' | grep -v 'tests/' | grep -v 'node_modules/' | xargs -r grep -l 'console\.log' 2>/dev/null || true)
if [ -n "$CONSOLE_LOGS" ]; then
    echo -e "${YELLOW}‚ö† Warning: console.log found:${NC}"
    echo "$CONSOLE_LOGS"
else
    echo -e "${GREEN}‚úì${NC}"
fi

# 2. V√©rifier texte fran√ßais hardcod√© (ignorer lang/ et tests/)
echo -n "2. Checking for hardcoded French text... "
HARDCODED=$(git diff --cached --name-only | grep -E '\.(php|phtml|js)$' | grep -v 'lang/' | grep -v 'tests/' | xargs -r grep -E "'(Erreur|Succ√®s|Veuillez|Chargement|Aucun)[^']*'" 2>/dev/null | grep -v '__(' | grep -v 'i18n' || true)
if [ -n "$HARDCODED" ]; then
    echo -e "${RED}‚úó Hardcoded French text found:${NC}"
    echo "$HARDCODED"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì${NC}"
fi

# 3. V√©rifier chemins absolus
echo -n "3. Checking for absolute paths... "
ABS_PATHS=$(git diff --cached --name-only | grep -E '\.(php|phtml)$' | xargs -r grep -E "'/var/www/|'/home/" 2>/dev/null || true)
if [ -n "$ABS_PATHS" ]; then
    echo -e "${RED}‚úó Absolute paths found:${NC}"
    echo "$ABS_PATHS"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì${NC}"
fi

# 4. V√©rifier syntaxe PHP (si PHP disponible)
echo -n "4. Checking PHP syntax... "
if command -v php &> /dev/null; then
    PHP_FILES=$(git diff --cached --name-only | grep -E '\.php$' || true)
    PHP_ERRORS=0
    for file in $PHP_FILES; do
        if [ -f "$file" ]; then
            php -l "$file" > /dev/null 2>&1 || {
                echo -e "${RED}‚úó Syntax error in $file${NC}"
                php -l "$file"
                PHP_ERRORS=$((PHP_ERRORS + 1))
                ERRORS=$((ERRORS + 1))
            }
        fi
    done
    if [ $PHP_ERRORS -eq 0 ]; then
        echo -e "${GREEN}‚úì${NC}"
    fi
else
    echo -e "${YELLOW}‚ö† PHP not found, skipping${NC}"
fi

# 5. V√©rifier accents manquants
echo -n "5. Checking for missing accents... "
MISSING_ACCENTS=$(git diff --cached --name-only | grep -E '\.(php|phtml)$' | xargs -r grep -E "'(cree|creee|mise a jour|succes|resultat|termine|echoue|selectionnez|supprime|reussi)'" 2>/dev/null || true)
if [ -n "$MISSING_ACCENTS" ]; then
    echo -e "${RED}‚úó Missing French accents found:${NC}"
    echo "$MISSING_ACCENTS"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì${NC}"
fi

# 6. V√©rifier fetch() sans ApiService
echo -n "6. Checking for raw fetch() calls... "
RAW_FETCH=$(git diff --cached --name-only | grep -E '\.js$' | xargs -r grep -E "fetch\(['\"]" 2>/dev/null | grep -v 'ApiService' | grep -v '// allowed' || true)
if [ -n "$RAW_FETCH" ]; then
    echo -e "${YELLOW}‚ö† Warning: Direct fetch() calls found (use ApiService):${NC}"
    echo "$RAW_FETCH"
else
    echo -e "${GREEN}‚úì${NC}"
fi

# 7. V√©rifier .env non commit√©
echo -n "7. Checking .env files... "
ENV_FILES=$(git diff --cached --name-only | grep -E '^\.env$|\.env\.local$|\.env\.production$' || true)
if [ -n "$ENV_FILES" ]; then
    echo -e "${RED}‚úó .env files should not be committed:${NC}"
    echo "$ENV_FILES"
    ERRORS=$((ERRORS + 1))
else
    echo -e "${GREEN}‚úì${NC}"
fi

echo ""
echo "=============================="

if [ $ERRORS -gt 0 ]; then
    echo -e "${RED}‚ùå Pre-commit hook failed with $ERRORS error(s)${NC}"
    echo "Fix the issues above and try again."
    exit 1
else
    echo -e "${GREEN}‚úÖ All checks passed!${NC}"
    exit 0
fi
