<!DOCTYPE html>
<html lang="<?= $_SESSION['lang'] ?? 'fr' ?>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="theme-color" content="#2D5A4A">
    <meta name="description" content="<?= __('app.tagline') ?>">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TripSalama">
    <meta name="application-name" content="TripSalama">
    <meta name="msapplication-TileColor" content="#2D5A4A">
    <meta name="msapplication-config" content="<?= asset_url('browserconfig.xml') ?>">
    <?= csrf_meta() ?>

    <title><?= $pageTitle ?? __('app.name') ?> - <?= __('app.name') ?></title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="<?= base_url('manifest.json') ?>">

    <!-- Favicon & App Icons -->
    <link rel="icon" type="image/svg+xml" href="<?= asset_url('images/icons/icon.svg') ?>">
    <link rel="icon" type="image/png" sizes="32x32" href="<?= asset_url('images/icons/icon-32x32.png') ?>">
    <link rel="icon" type="image/png" sizes="16x16" href="<?= asset_url('images/icons/icon-16x16.png') ?>">
    <link rel="apple-touch-icon" sizes="180x180" href="<?= asset_url('images/icons/apple-touch-icon.png') ?>">
    <link rel="mask-icon" href="<?= asset_url('images/icons/safari-pinned-tab.svg') ?>" color="#2D5A4A">

    <!-- Leaflet CSS -->
    <?php if (!empty($includeMap)): ?>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="">
    <?php endif; ?>

    <!-- Design System CSS (includes Google Fonts) -->
    <link rel="stylesheet" href="<?= versioned_asset('css/tripsalama-design-system.css') ?>">

    <!-- Page-specific CSS -->
    <?php if (!empty($pageCss)): ?>
    <?php foreach ((array)$pageCss as $css): ?>
    <link rel="stylesheet" href="<?= versioned_asset('css/' . $css) ?>">
    <?php endforeach; ?>
    <?php endif; ?>

    <!-- App Config -->
    <script>
        window.AppConfig = {
            basePath: <?= json_encode(config('base_path', '')) ?>,
            apiPath: "/api",
            lang: <?= json_encode($_SESSION['lang'] ?? 'fr') ?>,
            csrfToken: <?= json_encode(csrf_token()) ?>,
            debug: <?= json_encode(config('debug', false)) ?>
        };
    </script>
</head>
<body class="<?= $bodyClass ?? '' ?>">
    <!-- Skip link -->
    <a href="#main-content" class="skip-link"><?= __('nav.skip_to_content') ?? 'Aller au contenu' ?></a>

    <?php if (is_authenticated()): ?>
    <!-- Header -->
    <header class="app-header glass-header">
        <div class="header-inner">
            <a href="<?= base_url(has_role('driver') ? 'driver/dashboard' : 'passenger/dashboard') ?>" class="logo">
                <img src="<?= asset_url('images/icons/icon.svg') ?>" alt="" style="width: 36px; height: 36px; border-radius: var(--radius-md);">
                <span class="logo-text">Trip<span>Salama</span></span>
            </a>

            <nav class="header-nav" aria-label="Navigation principale">
                <?php if (has_role('passenger')): ?>
                <a href="<?= base_url('passenger/book') ?>" class="header-nav-btn <?= ($currentPage ?? '') === 'book' ? 'active' : '' ?>" title="<?= __('nav.book') ?>">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <line x1="12" y1="8" x2="12" y2="16"/>
                        <line x1="8" y1="12" x2="16" y2="12"/>
                    </svg>
                </a>
                <a href="<?= base_url('passenger/history') ?>" class="header-nav-btn <?= ($currentPage ?? '') === 'history' ? 'active' : '' ?>" title="<?= __('nav.history') ?>">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                </a>
                <?php endif; ?>

                <a href="<?= base_url('profile') ?>" class="header-nav-btn <?= ($currentPage ?? '') === 'profile' ? 'active' : '' ?>" title="<?= __('nav.profile') ?>">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                </a>

                <form action="<?= base_url('logout') ?>" method="POST" style="margin:0;">
                    <?= csrf_field() ?>
                    <button type="submit" class="header-nav-btn" title="<?= __('nav.logout') ?>">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16,17 21,12 16,7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </form>
            </nav>
        </div>
    </header>
    <?php endif; ?>

    <!-- Flash Messages -->
    <?php if (has_flash()): ?>
    <div class="flash-container">
        <?php foreach (get_flash() as $type => $messages): ?>
            <?php foreach ($messages as $message): ?>
            <div class="flash flash-<?= $type ?>" role="alert">
                <svg class="flash-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <?php if ($type === 'success'): ?>
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                    <?php elseif ($type === 'error'): ?>
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="15" y1="9" x2="9" y2="15"/>
                    <line x1="9" y1="9" x2="15" y2="15"/>
                    <?php else: ?>
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                    <?php endif; ?>
                </svg>
                <span class="flash-content"><?= htmlspecialchars($message) ?></span>
                <button type="button" class="flash-close" aria-label="Fermer">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <line x1="18" y1="6" x2="6" y2="18"/>
                        <line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <?php endforeach; ?>
        <?php endforeach; ?>
    </div>
    <?php endif; ?>

    <!-- App Container -->
    <div class="app-container">
        <!-- Main Content -->
        <main id="main-content" class="main-content page">
            <?= $content ?? '' ?>
        </main>

        <?php if (is_authenticated()): ?>
        <!-- Mobile Navigation -->
        <nav class="mobile-nav glass-header" aria-label="Navigation mobile">
            <div class="mobile-nav-inner">
                <?php if (has_role('passenger')): ?>
                <a href="<?= base_url('passenger/dashboard') ?>" class="nav-item <?= ($currentPage ?? '') === 'dashboard' ? 'active' : '' ?>">
                    <span class="nav-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        </svg>
                    </span>
                    <span class="nav-item-label"><?= __('nav.home') ?></span>
                </a>
                <a href="<?= base_url('passenger/book') ?>" class="nav-item <?= ($currentPage ?? '') === 'book' ? 'active' : '' ?>">
                    <span class="nav-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="16"/>
                            <line x1="8" y1="12" x2="16" y2="12"/>
                        </svg>
                    </span>
                    <span class="nav-item-label"><?= __('nav.book') ?></span>
                </a>
                <a href="<?= base_url('passenger/history') ?>" class="nav-item <?= ($currentPage ?? '') === 'history' ? 'active' : '' ?>">
                    <span class="nav-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    </span>
                    <span class="nav-item-label"><?= __('nav.history') ?></span>
                </a>
                <?php else: ?>
                <a href="<?= base_url('driver/dashboard') ?>" class="nav-item <?= ($currentPage ?? '') === 'dashboard' ? 'active' : '' ?>">
                    <span class="nav-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                    </span>
                    <span class="nav-item-label"><?= __('nav.dashboard') ?></span>
                </a>
                <?php endif; ?>
                <a href="<?= base_url('profile') ?>" class="nav-item <?= ($currentPage ?? '') === 'profile' ? 'active' : '' ?>">
                    <span class="nav-item-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </span>
                    <span class="nav-item-label"><?= __('nav.profile') ?></span>
                </a>
            </div>
        </nav>
        <?php endif; ?>
    </div>

    <!-- Leaflet JS -->
    <?php if (!empty($includeMap)): ?>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <?php endif; ?>

    <!-- Core JS -->
    <script src="<?= versioned_asset('js/core/app-config.js') ?>"></script>
    <script src="<?= versioned_asset('js/core/api-service.js') ?>"></script>
    <script src="<?= versioned_asset('js/core/event-bus.js') ?>"></script>
    <script src="<?= versioned_asset('js/core/state-manager.js') ?>"></script>
    <script src="<?= versioned_asset('js/core/i18n.js') ?>"></script>
    <script src="<?= versioned_asset('js/core/geolocation-service.js') ?>"></script>
    <script src="<?= versioned_asset('js/core/tracking-service.js') ?>"></script>

    <!-- Components -->
    <script src="<?= versioned_asset('js/components/toast-notification.js') ?>"></script>
    <script src="<?= versioned_asset('js/components/modal.js') ?>"></script>

    <!-- Page-specific JS -->
    <?php if (!empty($pageJs)): ?>
    <?php foreach ((array)$pageJs as $js): ?>
    <script src="<?= versioned_asset('js/' . $js) ?>"></script>
    <?php endforeach; ?>
    <?php endif; ?>

    <!-- Flash messages auto-close -->
    <script>
        document.querySelectorAll('.flash-close').forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.flash').remove();
            });
        });
        setTimeout(() => {
            document.querySelectorAll('.flash').forEach(msg => {
                msg.style.animation = 'fadeIn var(--duration-normal) var(--ease-out-expo) reverse forwards';
                setTimeout(() => msg.remove(), 300);
            });
        }, 5000);
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('[App] Service Worker registered:', registration.scope);

                        // Écouter les mises à jour
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // Nouvelle version disponible
                                    if (typeof Toast !== 'undefined') {
                                        Toast.info('Une mise à jour est disponible. Rafraîchissez la page.');
                                    }
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.warn('[App] Service Worker registration failed:', error);
                    });

                // Écouter les messages du Service Worker
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SYNC_POSITIONS') {
                        // Déclencher la synchronisation des positions
                        if (typeof TrackingService !== 'undefined') {
                            TrackingService.syncPendingPositions();
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
