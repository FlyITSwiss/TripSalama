<!-- CSS Chat -->
<link rel="stylesheet" href="<?= asset_url('css/ride-chat.css') ?>">

<div class="navigation-page">
    <!-- En-tête avec infos course -->
    <div class="navigation-header">
        <div class="ride-status-badge <?= $ride['status'] ?>">
            <?= __('ride.' . $ride['status']) ?>
        </div>
        <div class="passenger-info">
            <span class="passenger-name"><?= htmlspecialchars($ride['passenger_first_name'] . ' ' . $ride['passenger_last_name']) ?></span>
        </div>
    </div>

    <!-- Carte plein écran -->
    <div id="navigationMap" class="navigation-map"></div>

    <!-- Panel d'actions flottant -->
    <div class="navigation-panel">
        <!-- Adresses -->
        <div class="navigation-addresses">
            <div class="nav-address pickup <?= $ride['status'] === 'accepted' ? 'active' : '' ?>">
                <span class="nav-address-dot pickup"></span>
                <div class="nav-address-content">
                    <span class="nav-address-label"><?= __('ride.pickup') ?></span>
                    <span class="nav-address-text"><?= htmlspecialchars($ride['pickup_address']) ?></span>
                </div>
            </div>
            <div class="nav-address dropoff <?= $ride['status'] === 'in_progress' ? 'active' : '' ?>">
                <span class="nav-address-dot dropoff"></span>
                <div class="nav-address-content">
                    <span class="nav-address-label"><?= __('ride.dropoff') ?></span>
                    <span class="nav-address-text"><?= htmlspecialchars($ride['dropoff_address']) ?></span>
                </div>
            </div>
        </div>

        <!-- Infos temps/distance -->
        <div class="navigation-stats">
            <div class="nav-stat">
                <span class="nav-stat-value" id="etaValue">--</span>
                <span class="nav-stat-label"><?= __('ride.eta') ?></span>
            </div>
            <div class="nav-stat">
                <span class="nav-stat-value" id="distanceValue">--</span>
                <span class="nav-stat-label"><?= __('ride.distance') ?></span>
            </div>
            <div class="nav-stat">
                <span class="nav-stat-value"><?= format_price((float)$ride['estimated_price']) ?></span>
                <span class="nav-stat-label"><?= __('ride.price') ?></span>
            </div>
        </div>

        <!-- Boutons d'action -->
        <div class="navigation-actions">
            <?php if ($ride['status'] === 'accepted'): ?>
            <button type="button" class="btn btn-primary btn-block" id="arrivedBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <?= __('driver.arrived_pickup') ?>
            </button>
            <?php elseif ($ride['status'] === 'in_progress'): ?>
            <button type="button" class="btn btn-success btn-block" id="completeBtn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                    <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                <?= __('driver.complete_ride') ?>
            </button>
            <?php endif; ?>

            <button type="button" class="btn btn-outline" id="cancelRideBtn">
                <?= __('action.cancel') ?>
            </button>
        </div>
    </div>
</div>

<script src="<?= asset_url('js/modules/ride-chat.js') ?>"></script>
<script>
    // Configuration i18n pour le chat
    window.ChatI18n = {
        title: <?= json_encode(__('chat.title')) ?>,
        placeholder: <?= json_encode(__('chat.placeholder')) ?>,
        no_messages: <?= json_encode(__('chat.no_messages')) ?>,
        message_sent: <?= json_encode(__('chat.message_sent')) ?>,
        driver_arriving: <?= json_encode(__('chat.driver_arriving')) ?>,
        driver_arrived: <?= json_encode(__('chat.driver_arrived')) ?>,
        driver_where_are_you: <?= json_encode(__('chat.driver_where_are_you')) ?>,
        driver_waiting: <?= json_encode(__('chat.driver_waiting')) ?>,
        driver_traffic: <?= json_encode(__('chat.driver_traffic')) ?>,
        call_not_available: <?= json_encode(__('call.not_available')) ?>
    };
</script>
<script>
    window.NavigationConfig = {
        rideId: <?= (int)$ride['id'] ?>,
        status: <?= json_encode($ride['status']) ?>,
        pickup: {
            lat: <?= (float)$ride['pickup_lat'] ?>,
            lng: <?= (float)$ride['pickup_lng'] ?>,
            address: <?= json_encode($ride['pickup_address']) ?>
        },
        dropoff: {
            lat: <?= (float)$ride['dropoff_lat'] ?>,
            lng: <?= (float)$ride['dropoff_lng'] ?>,
            address: <?= json_encode($ride['dropoff_address']) ?>
        },
        routePolyline: <?= json_encode($ride['route_polyline'] ?? null) ?>,
        i18n: {
            arrivedPickup: <?= json_encode(__('driver.arrived_pickup')) ?>,
            startRide: <?= json_encode(__('driver.start_ride')) ?>,
            completeRide: <?= json_encode(__('driver.complete_ride')) ?>,
            rideCompleted: <?= json_encode(__('msg.ride_completed')) ?>,
            confirmCancel: <?= json_encode(__('ride.confirm_cancel')) ?>,
            error: <?= json_encode(__('error.generic')) ?>
        }
    };

</script>

<!-- Initialisation Chat (isolé des erreurs carte) -->
<?php if (in_array($ride['status'], ['accepted', 'driver_arriving', 'in_progress'])): ?>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            if (typeof RideChat !== 'undefined' && RideChat.init) {
                RideChat.init(
                    <?= (int)$ride['id'] ?>,
                    'driver',
                    <?= (int)(current_user()['id'] ?? 0) ?>
                );
                console.log('RideChat initialized successfully');
            } else {
                console.warn('RideChat module not available');
            }
        } catch (e) {
            console.error('RideChat init error:', e);
        }
    });
</script>
<?php endif; ?>
