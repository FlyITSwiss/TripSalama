<?php
/**
 * TripSalama - Page RÃ©servation
 * Design Uber Premium - Fullscreen Map + Bottom Sheet
 */
?>

<style>
    /* Full Screen Map Layout - Account for bottom nav */
    .booking-page {
        position: fixed;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 100%;
        max-width: 420px;
        height: calc(100vh - var(--nav-height));
        overflow: hidden;
    }

    /* Map Container - Full screen */
    .booking-map-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: var(--uber-gray-100);
    }

    .booking-map {
        width: 100%;
        height: 100%;
    }

    /* Hide Leaflet attribution */
    .booking-map .leaflet-control-attribution {
        display: none !important;
    }

    /* Uber-style map controls */
    .booking-map .leaflet-control-zoom {
        border: none !important;
        box-shadow: var(--shadow-md) !important;
        border-radius: var(--radius-lg) !important;
        overflow: hidden;
        margin: var(--space-4) !important;
    }

    .booking-map .leaflet-control-zoom a {
        width: 40px !important;
        height: 40px !important;
        line-height: 40px !important;
        font-size: 18px !important;
        color: var(--uber-black) !important;
        background: var(--uber-white) !important;
        border: none !important;
    }

    .booking-map .leaflet-control-zoom a:hover {
        background: var(--uber-gray-100) !important;
    }

    /* Back Button */
    .booking-back {
        position: absolute;
        top: var(--space-4);
        left: var(--space-4);
        width: 48px;
        height: 48px;
        background: var(--uber-white);
        border: none;
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--uber-black);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .booking-back:hover {
        background: var(--uber-gray-100);
    }

    .booking-back svg {
        width: 24px;
        height: 24px;
    }

    /* Location Button - above bottom sheet */
    .booking-locate-btn {
        position: absolute;
        bottom: 260px;
        right: var(--space-4);
        width: 48px;
        height: 48px;
        background: var(--uber-white);
        border: none;
        border-radius: var(--radius-full);
        box-shadow: var(--shadow-md);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--uber-black);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.2s ease;
    }

    .booking-locate-btn:hover {
        background: var(--uber-black);
        color: var(--uber-white);
        transform: scale(1.05);
    }

    .booking-locate-btn.locating {
        background: var(--uber-black);
        color: var(--uber-white);
    }

    .booking-locate-btn.locating svg {
        animation: pulse 1.5s ease-in-out infinite;
    }

    .booking-locate-btn svg {
        width: 24px;
        height: 24px;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.1); opacity: 0.7; }
    }

    /* Bottom Sheet - fits above bottom nav */
    .booking-sheet {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--uber-white);
        border-radius: var(--radius-3xl) var(--radius-3xl) 0 0;
        box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.12);
        z-index: 1001;
        padding: var(--space-4);
        padding-bottom: var(--space-4);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-height: 50%;
        overflow-y: auto;
    }

    /* Drag Handle */
    .booking-sheet-handle {
        width: 36px;
        height: 4px;
        background: var(--uber-gray-300);
        border-radius: var(--radius-full);
        margin: 0 auto var(--space-4);
    }

    /* Address Inputs */
    .booking-form {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .booking-input-row {
        display: flex;
        align-items: stretch;
        gap: var(--space-3);
    }

    .booking-indicator {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-3) 0;
        width: 24px;
        flex-shrink: 0;
    }

    .booking-dot {
        width: 10px;
        height: 10px;
        border-radius: var(--radius-full);
        flex-shrink: 0;
    }

    .booking-dot.pickup {
        background: var(--uber-black);
    }

    .booking-dot.dropoff {
        background: transparent;
        border: 2px solid var(--uber-black);
    }

    .booking-line {
        flex: 1;
        width: 2px;
        margin: var(--space-1) 0;
        background: var(--uber-gray-300);
    }

    .booking-input-wrapper {
        flex: 1;
        position: relative;
    }

    .booking-input {
        width: 100%;
        padding: var(--space-4);
        font-family: var(--font-family);
        font-size: var(--text-base);
        font-weight: var(--font-medium);
        color: var(--uber-black);
        background: var(--uber-gray-100);
        border: 2px solid transparent;
        border-radius: var(--radius-lg);
        transition: all 0.2s ease;
    }

    .booking-input:focus {
        outline: none;
        background: var(--uber-white);
        border-color: var(--uber-black);
    }

    .booking-input::placeholder {
        color: var(--uber-gray-500);
        font-weight: var(--font-normal);
    }

    /* Autocomplete Dropdown */
    .booking-dropdown {
        position: absolute;
        top: calc(100% + var(--space-2));
        left: 0;
        right: 0;
        background: var(--uber-white);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1002;
    }

    .booking-dropdown.hidden {
        display: none;
    }

    .autocomplete-item {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        padding: var(--space-3) var(--space-4);
        cursor: pointer;
        transition: background 0.15s ease;
        border-bottom: 1px solid var(--uber-gray-100);
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover {
        background: var(--uber-gray-50);
    }

    .autocomplete-item-icon {
        width: 24px;
        height: 24px;
        color: var(--uber-gray-500);
        flex-shrink: 0;
    }

    .autocomplete-item-text {
        flex: 1;
        min-width: 0;
    }

    .autocomplete-item-primary {
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        color: var(--uber-black);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .autocomplete-item-secondary {
        font-size: var(--text-xs);
        color: var(--uber-gray-500);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Estimation Card */
    .booking-estimation {
        margin-top: var(--space-4);
        padding: var(--space-4);
        background: var(--uber-gray-50);
        border-radius: var(--radius-xl);
    }

    .booking-estimation.hidden {
        display: none;
    }

    .estimation-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-2) 0;
    }

    .estimation-row:not(:last-child) {
        border-bottom: 1px solid var(--uber-gray-200);
    }

    .estimation-label {
        font-size: var(--text-sm);
        color: var(--uber-gray-500);
    }

    .estimation-value {
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--uber-black);
    }

    .estimation-price {
        font-size: var(--text-2xl);
        font-weight: var(--font-bold);
        color: var(--uber-black);
    }

    /* Confirm Button */
    .booking-confirm {
        width: 100%;
        margin-top: var(--space-4);
        padding: var(--space-4) var(--space-6);
        font-family: var(--font-family);
        font-size: var(--text-base);
        font-weight: var(--font-semibold);
        color: var(--uber-white);
        background: var(--uber-black);
        border: none;
        border-radius: var(--radius-lg);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
    }

    .booking-confirm:hover:not(:disabled) {
        background: var(--uber-gray-800);
    }

    .booking-confirm:active:not(:disabled) {
        transform: scale(0.98);
    }

    .booking-confirm:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .booking-confirm.hidden {
        display: none;
    }

    .booking-confirm svg {
        width: 20px;
        height: 20px;
    }

    /* Status Indicator */
    .pickup-status {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
        margin-top: var(--space-2);
        font-size: var(--text-sm);
        border-radius: var(--radius-md);
    }

    .pickup-status.hidden { display: none; }

    .pickup-status.detecting {
        background: var(--uber-blue-soft);
        color: var(--uber-blue);
    }

    .pickup-status.found {
        background: var(--uber-green-soft);
        color: var(--uber-green);
    }

    .pickup-status.error {
        background: var(--uber-red-soft);
        color: var(--uber-red);
    }

    .status-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid currentColor;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>

<div class="booking-page">
    <!-- Map Container -->
    <div class="booking-map-container">
        <div id="map" class="booking-map"></div>
    </div>

    <!-- Back Button -->
    <a href="<?= base_url('passenger/dashboard') ?>" class="booking-back">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="15 18 9 12 15 6"/>
        </svg>
    </a>

    <!-- Location Button -->
    <button type="button" id="locateMeBtn" class="booking-locate-btn" title="<?= __('booking.my_location') ?>">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="3"/>
            <line x1="12" y1="2" x2="12" y2="6"/>
            <line x1="12" y1="18" x2="12" y2="22"/>
            <line x1="2" y1="12" x2="6" y2="12"/>
            <line x1="18" y1="12" x2="22" y2="12"/>
        </svg>
    </button>

    <!-- Bottom Sheet -->
    <div class="booking-sheet">
        <div class="booking-sheet-handle"></div>

        <form id="bookingForm" class="booking-form">
            <!-- Pickup -->
            <div class="booking-input-row">
                <div class="booking-indicator">
                    <span class="booking-dot pickup"></span>
                    <span class="booking-line"></span>
                </div>
                <div class="booking-input-wrapper">
                    <input type="text" id="pickupInput" class="booking-input"
                           placeholder="<?= __('booking.pickup_placeholder') ?>"
                           autocomplete="off">
                    <input type="hidden" id="pickupLat" name="pickup_lat">
                    <input type="hidden" id="pickupLng" name="pickup_lng">
                    <input type="hidden" id="pickupAddress" name="pickup_address">
                    <div id="pickupDropdown" class="booking-dropdown hidden"></div>
                    <div id="pickupStatusIndicator" class="pickup-status hidden">
                        <span class="status-spinner"></span>
                        <span class="status-text"></span>
                    </div>
                </div>
            </div>

            <!-- Dropoff -->
            <div class="booking-input-row">
                <div class="booking-indicator">
                    <span class="booking-dot dropoff"></span>
                </div>
                <div class="booking-input-wrapper">
                    <input type="text" id="dropoffInput" class="booking-input"
                           placeholder="<?= __('booking.dropoff_placeholder') ?>"
                           autocomplete="off">
                    <input type="hidden" id="dropoffLat" name="dropoff_lat">
                    <input type="hidden" id="dropoffLng" name="dropoff_lng">
                    <input type="hidden" id="dropoffAddress" name="dropoff_address">
                    <div id="dropoffDropdown" class="booking-dropdown hidden"></div>
                </div>
            </div>
        </form>

        <!-- Estimation -->
        <div id="estimationCard" class="booking-estimation hidden">
            <div class="estimation-row">
                <span class="estimation-label"><?= __('booking.distance') ?></span>
                <span class="estimation-value" id="estimatedDistance">-</span>
            </div>
            <div class="estimation-row">
                <span class="estimation-label"><?= __('booking.duration') ?></span>
                <span class="estimation-value" id="estimatedDuration">-</span>
            </div>
            <div class="estimation-row">
                <span class="estimation-label"><?= __('booking.price') ?></span>
                <span class="estimation-price" id="estimatedPrice">-</span>
            </div>
        </div>

        <!-- Confirm Button -->
        <button type="submit" form="bookingForm" id="confirmBtn" class="booking-confirm hidden">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <?= __('booking.confirm_ride') ?>
        </button>
    </div>
</div>

<script>
    // Configuration pour le module booking
    window.BookingConfig = {
        apiUrl: AppConfig.apiPath,
        csrfToken: AppConfig.csrfToken,
        defaultCenter: [33.5731, -7.5898], // Casablanca, Morocco
        defaultZoom: 14,
        autoLocate: true,
        i18n: {
            searching: <?= json_encode(__('ride.searching')) ?>,
            noResults: <?= json_encode(__('booking.no_results')) ?>,
            error: <?= json_encode(__('error.generic')) ?>,
            geolocationError: <?= json_encode(__('error.geolocation')) ?>,
            detectingLocation: <?= json_encode(__('booking.detecting_location')) ?>,
            locationFound: <?= json_encode(__('booking.location_found')) ?>,
            confirmRide: <?= json_encode(__('booking.confirm_ride')) ?>,
            rideCreated: <?= json_encode(__('msg.ride_booked')) ?>
        }
    };
</script>
